<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ÙØ±Ø² Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠØ©</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .btn-primary:hover,.btn-secondary:hover,.btn-success:hover,.btn-warning:hover{transform:translateY(-2px)}.header,.modal-header,.stat-card{text-align:center}*{margin:0;padding:0;box-sizing:border-box}html{font-size:16px}body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);min-height:100vh;padding:clamp(10px,2vw,20px);line-height:1.6}.container{max-width:1400px;width:100%;margin:0 auto;background:#fff;border-radius:clamp(8px,1.5vw,15px);box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}.header{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;padding:clamp(20px,4vw,30px)}.candidates-table tr:hover,.section{background:#f8f9fa}.header p{font-size:clamp(1.5rem, 4vw, 2.5rem);font-weight:700;margin:0;text-shadow:2px 2px 4px rgba(0,0,0,.3)}.main-content{padding:clamp(15px,3vw,30px)}.section{margin-bottom:clamp(15px,2.5vw,25px);padding:clamp(15px,3vw,25px);border-radius:clamp(8px,1vw,12px);box-shadow:0 4px 6px rgba(0,0,0,.05);border-right:5px solid #667eea}.section-title{color:#2c3e50;font-size:clamp(1.2rem, 2.5vw, 1.5rem);margin-bottom:clamp(15px,2vw,20px);padding-bottom:10px;border-bottom:2px solid #ecf0f1;display:flex;align-items:center;gap:clamp(8px,1vw,10px);flex-wrap:wrap}.alert,.btn,.input-group label,.stat-label{font-size:clamp(.9rem, 1.5vw, 1rem)}.input-group label,.stat-number{margin-bottom:clamp(6px,1vw,8px)}.section-title::before{content:"ğŸ“Š";font-size:1.2em}.button-group{display:flex;gap:clamp(10px,2vw,15px);justify-content:center;flex-wrap:wrap;margin-top:clamp(15px,2vw,20px)}.btn{padding:clamp(10px,1.5vw,12px) clamp(20px,3vw,25px);border:none;border-radius:clamp(6px,1vw,8px);font-weight:600;cursor:pointer;transition:.3s;display:flex;align-items:center;gap:clamp(6px,1vw,8px);min-width:clamp(120px,20vw,150px);justify-content:center;flex:1 1 auto;max-width:200px}.btn-primary{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff}.btn-primary:hover{box-shadow:0 6px 12px rgba(46,204,113,.3)}.btn-warning{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff}.btn-warning:hover{box-shadow:0 6px 12px rgba(243,156,18,.3)}.btn-danger{background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff}.btn-danger:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 6px 12px rgba(231,76,60,.3)}.btn-secondary{background:linear-gradient(135deg,#95a5a6,#7f8c8d);color:#fff}.btn-secondary:hover{box-shadow:0 6px 12px rgba(149,165,166,.3)}.btn-success{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff}.btn-success:hover{box-shadow:0 6px 12px rgba(52,152,219,.3)}.btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important}.stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(min(200px,100%),1fr));gap:clamp(15px,2vw,20px)}.stat-card{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;padding:clamp(20px,3vw,25px);border-radius:clamp(8px,1vw,12px);box-shadow:0 8px 16px rgba(102,126,234,.3);transition:transform .3s}.stat-card:hover{transform:translateY(-5px)}.stat-number{font-size:clamp(1.8rem, 4vw, 2.5rem);font-weight:700}.stat-label{opacity:.9}.alert{padding:clamp(12px,2vw,15px);border-radius:clamp(6px,1vw,8px);margin-bottom:clamp(15px,2vw,20px);display:none;font-weight:500}.alert-error{background:#ffebee;color:#c62828;border-right:4px solid #e53935}.alert-success{background:#e8f5e8;color:#2e7d32;border-right:4px solid #4caf50}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);padding:clamp(10px,2vw,20px)}.modal-content{background-color:#fff;margin:clamp(5%,10vh,15%) auto;padding:clamp(20px,4vw,30px);border-radius:clamp(8px,1vw,12px);width:100%;max-width:min(500px,95vw);box-shadow:0 20px 40px rgba(0,0,0,.3);max-height:90vh;overflow-y:auto}.modal-header{font-size:clamp(1.3rem, 2.5vw, 1.5rem);font-weight:700;color:#2c3e50;margin-bottom:clamp(15px,2vw,20px)}.candidates-table{width:100%;border-collapse:collapse;margin-top:clamp(15px,2vw,20px);background:#fff;border-radius:clamp(6px,1vw,8px);overflow:hidden;box-shadow:0 4px 6px rgba(0,0,0,.1);font-size:clamp(.8rem, 1.2vw, 1rem)}.candidates-table td,.candidates-table th{padding:clamp(10px,2vw,15px);text-align:center;border-bottom:1px solid #ecf0f1}.candidates-table th{background:linear-gradient(135deg,#34495e,#2c3e50);color:#fff;font-weight:600}@media (max-width:575.98px){.stats-container,.voting-form{grid-template-columns:1fr}.button-group{flex-direction:column}.btn{max-width:none;min-width:auto}.candidates-table{font-size:.8rem}.candidates-table td,.candidates-table th{padding:8px 5px}}@media (min-width:576px) and (max-width:767.98px){.stats-container{grid-template-columns:repeat(2,1fr)}}@media (min-width:768px) and (max-width:991.98px){.stats-container,.voting-form{grid-template-columns:repeat(2,1fr)}}@media (min-width:992px) and (max-width:1199.98px){.stats-container,.voting-form{grid-template-columns:repeat(3,1fr)}}@media (min-width:1200px){.stats-container,.voting-form{grid-template-columns:repeat(4,1fr)}}@media (min-width:1400px){.container{max-width:1400px}}@media print{body{background:#fff;padding:0}.container{box-shadow:none;border-radius:0}.btn,.modal{display:none!important}}@media (-webkit-min-device-pixel-ratio:2),(min-resolution:192dpi){.header p{text-shadow:1px 1px 2px rgba(0,0,0,.3)}}@media (max-width:767.98px) and (orientation:landscape){.modal-content{margin:2% auto;max-height:95vh}}@media (prefers-reduced-motion:reduce){*{animation-duration:0s!important;animation-iteration-count:1!important;transition-duration:0s!important}.btn:hover,.stat-card:hover{transform:none}}.btn:focus-visible,.input-group input:focus-visible,.input-group select:focus-visible{outline:#667eea solid 3px;outline-offset:2px}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}.voting-form{display:grid;grid-template-columns:repeat(auto-fit,minmax(min(250px,100%),1fr));gap:clamp(15px,2vw,20px)}.voting-form .input-group{display:flex;flex-direction:column;min-width:0}.voting-form .input-group label{font-weight:600;color:#34495e;margin-bottom:8px}.voting-form .input-group input,.voting-form .input-group select{padding:clamp(10px,1.5vw,12px) clamp(12px,2vw,15px);border:2px solid #ddd;border-radius:clamp(6px,1vw,8px);font-size:clamp(.9rem, 1.5vw, 1rem);transition:.3s;background:#fff;width:100%}.voting-form .input-group input:focus,.voting-form .input-group select:focus{outline:0;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}.vote-recording{max-width:600px;margin:20px auto}.vote-recording .input-group{display:flex;align-items:center;margin-bottom:12px;border:1px solid #ddd;border-radius:8px;overflow:hidden;background:#fff;transition:.3s}.vote-recording .input-group:hover{border-color:#007bff;box-shadow:0 2px 8px rgba(0,123,255,.15)}.vote-recording .input-group:focus-within{border-color:#007bff;box-shadow:0 0 0 3px rgba(0,123,255,.1);transform:scale(1.01)}.vote-recording .input-group label{background-color:#f8f9fa;padding:12px 20px;margin:0;font-weight:600;color:#495057;border-right:1px solid #ddd;white-space:nowrap;min-width:100px;text-align:left;font-size:14px}.vote-recording .input-group input{flex:1;border:none;padding:12px 15px;font-size:16px;outline:0;background:0 0;color:#495057}.vote-recording .input-group input:focus{background-color:#f8f9ff}.vote-recording .input-group input::placeholder{color:#adb5bd;opacity:1}.vote-recording.colored .input-group:nth-child(odd) label{background-color:#e3f2fd}.vote-recording.colored .input-group:nth-child(2n) label{background-color:#f3e5f5}@media screen and (max-width:768px){.vote-recording .input-group label{min-width:70px;padding:10px 12px;font-size:13px}.vote-recording .input-group input{padding:10px 12px;font-size:16px}}
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <p>ğŸ—³ï¸ Ù†Ø¸Ø§Ù… ÙØ±Ø² Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠØ©</p>
        </div>

        <div class="main-content">
            <div class="section">
                <h2 class="section-title">Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØµÙˆÙŠØª</h2>
                <div class="voting-form">
                    <div class="input-group">
                        <label class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø§Ø®Ø¨ÙŠÙ† Ø§Ù„Ù…Ù‚ÙŠØ¯ÙŠÙ† Ø¨Ø§Ù„Ù„Ø¬Ù†Ø©</label>
                        <input type="number" id="manualTotalVotesInput" placeholder="Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª"
                            class="stat-input" oninput="updateStats()">
                    </div>
                    <div class="input-group">
                        <label for="totalCandidatesInput">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†:</label>
                        <input type="number" id="totalCandidatesInput" placeholder="Ø£Ø¯Ø®Ù„ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†"
                            class="stat-input" oninput="addCandidateinput()">
                    </div>
                    <div class="input-group">
                        <label for="candidatesPerVote">Ø§Ù„ØªØµÙˆÙŠØª Ø§Ù„ØµØ­ÙŠØ­:</label>
                        <select id="candidatesPerVote" onchange="updateVotingForm()">
                            <option value="1">Ù…Ø±Ø´Ø­ ÙˆØ§Ø­Ø¯</option>
                            <option value="2">Ù…Ø±Ø´Ø­Ø§Ù†</option>
                            <option value="3">3 Ù…Ø±Ø´Ø­ÙŠÙ†</option>
                            <option value="4" selected>4 Ù…Ø±Ø´Ø­ÙŠÙ†</option>
                            <option value="5">5 Ù…Ø±Ø´Ø­ÙŠÙ†</option>
                            <option value="6">6 Ù…Ø±Ø´Ø­ÙŠÙ†</option>
                            <option value="7">7 Ù…Ø±Ø´Ø­ÙŠÙ†</option>
                            <option value="8">8 Ù…Ø±Ø´Ø­ÙŠÙ†</option>
                            <option value="9">9 Ù…Ø±Ø´Ø­ÙŠÙ†</option>
                            <option value="10">10 Ù…Ø±Ø´Ø­ÙŠÙ†</option>
                            <option value="11">11 Ù…Ø±Ø´Ø­</option>
                            <option value="12">12 Ù…Ø±Ø´Ø­</option>
                            <option value="13">13 Ù…Ø±Ø´Ø­</option>
                            <option value="14">14 Ù…Ø±Ø´Ø­</option>
                            <option value="15">15 Ù…Ø±Ø´Ø­</option>
                        </select>
                    </div>

                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„ØªØµÙˆÙŠØª -->
            <div class="section">
                <h2 class="section-title" id="votingSectionTitle">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„ØµØ­ÙŠØ­ (2 Ù…Ø±Ø´Ø­ÙŠÙ†)</h2>
                <div class="alert alert-error" id="errorAlert"></div>
                <div class="alert alert-success" id="successAlert"></div>

                <div class="vote-recording colored" id="votingInputs">
                    <div class="input-group">
                        <label class="text-align" for="candidate1">1</label>
                        <input type="number" id="candidate1" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø´Ø­">
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" onclick="recordVote()">
                        âœ… ØµÙˆØª ØµØ­ÙŠØ­
                    </button>
                    <button class="btn btn-warning" onclick="recordInvalidVote()">
                        âŒ ØµÙˆØª Ø¨Ø§Ø·Ù„
                    </button>
                    <button class="btn btn-danger" id="undoBtn" onclick="undoLastVote()" disabled>
                        â†©ï¸ ØªØ±Ø§Ø¬Ø¹ ØµÙˆØª
                    </button>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" id="saveDataBtn">
                        ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                    <button class="btn btn-primary" id="loadDataBtn">
                        ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                    <button class="btn btn-secondary" id="exportPdfBtn">
                        ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                    </button>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† -->
            <div class="section">
                <h2 class="section-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h2>
                <div class="button-group">
                    <button class="btn btn-success" onclick="showAddCandidateModal()">
                        â•ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø´Ø­
                    </button>

                    <button class="btn btn-warning" onclick="showDeleteCandidateModal()">
                        â–ğŸ‘¤ Ø­Ø°Ù Ù…Ø±Ø´Ø­
                    </button>

                    <button class="btn btn-secondary" onclick="resetAllVotes()">
                        ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
                    </button>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div class="section">
                <h2 class="section-title">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-number" id="totalCandidates">0</div>
                        <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalVotes">0</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalVoteSets">0</div>
                        <div class="stat-label">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="invalidVotes">0</div>
                        <div class="stat-label">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø¨Ø§Ø·Ù„Ø©</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="castedVotes">0</div>
                        <div class="stat-label">Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ù…ÙØ¯Ù„Ù‰ Ø¨Ù‡Ø§</div>
                    </div>
                </div>
            </div>

            <!-- Ù‚Ø³Ù… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† -->
            <div class="section" id="resultsSection">
                <h2 class="section-title">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h2>
                <table class="candidates-table" id="candidatesTable">
                    <thead>
                        <tr>
                            <th>Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø´Ø­</th>
                            <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª</th>
                            <th>Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th>
                        </tr>
                    </thead>
                    <tbody id="candidatesTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† -->
    <div id="addCandidateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">ØªØ¹ÙŠÙŠÙ† Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</div>
            <div class="input-group">
                <label for="totalCandidatesInput">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†:</label>
                <input type="number" id="totalCandidatesInput" min="1" max="50" value="2">
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="addCandidates()">ØªØ£ÙƒÙŠØ¯</button>
                <button class="btn btn-secondary" onclick="closeModal('addCandidateModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Modal Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø´Ø­ -->
    <div id="deleteCandidateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Ø­Ø°Ù Ù…Ø±Ø´Ø­</div>
            <div class="input-group">
                <label for="deleteCandidateInput">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø´Ø­ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡:</label>
                <input type="number" id="deleteCandidateInput" min="1">
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn btn-danger" onclick="deleteCandidate()">Ø­Ø°Ù</button>
                <button class="btn btn-secondary" onclick="closeModal('deleteCandidateModal')">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <script>
        let candidates = {};
        let validVotes = [];
        let invalidVotesCount = 0;
        let voteHistory = [];
        let isProcessing = false;
        let candidatesPerVote = 1;

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª iOS
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
        });

        function initializeApp() {
            try {
                // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø¹Ù„Ù‰ iOS
                if (isIOS) {
                    document.addEventListener('touchstart', preventZoom, { passive: false });
                    document.addEventListener('gesturestart', preventZoom, { passive: false });

                    // Ø¥Ø¶Ø§ÙØ© meta viewport Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
                    let viewport = document.querySelector("meta[name=viewport]");
                    if (!viewport) {
                        viewport = document.createElement('meta');
                        viewport.name = 'viewport';
                        viewport.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no';
                        document.getElementsByTagName('head')[0].appendChild(viewport);
                    }
                }

                loadDataOnStartup();
                setupSaveLoadButtons();
                setupAutoSave();
                updateVotingForm();
                updateStats();
                updateCandidatesTable();
                setupInputEventListeners();
                setupKeyboardListeners();

                // Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø£ÙˆÙ„ Ø­Ù‚Ù„
                setTimeout(() => {
                    focusFirstInput();
                }, 100);

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
            }
        }

        function preventZoom(e) {
            if (e.touches && e.touches.length > 1) {
                e.preventDefault();
            }
        }

        function focusFirstInput() {
            const firstInput = document.getElementById('candidate1');
            if (firstInput) {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… setTimeout Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ iOS
                setTimeout(() => {
                    firstInput.focus();
                    if (isIOS) {
                        firstInput.click();
                    }
                }, 50);
            }
        }

        function updateVotingForm() {
            try {
                candidatesPerVote = parseInt(document.getElementById('candidatesPerVote').value);
                const votingInputs = document.getElementById('votingInputs');
                const votingSectionTitle = document.getElementById('votingSectionTitle');

                if (!votingInputs || !votingSectionTitle) {
                    console.error('Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
                    return;
                }

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
                const candidateText = candidatesPerVote === 1 ? 'Ù…Ø±Ø´Ø­ ÙˆØ§Ø­Ø¯' :
                    candidatesPerVote === 2 ? 'Ù…Ø±Ø´Ø­Ø§Ù†' :
                        `${candidatesPerVote} Ù…Ø±Ø´Ø­ÙŠÙ†`;
                votingSectionTitle.textContent = `ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„ØµØ­ÙŠØ­ (${candidateText})`;

                // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
                votingInputs.innerHTML = '';

                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                for (let i = 1; i <= candidatesPerVote; i++) {
                    const inputGroup = document.createElement('div');
                    inputGroup.className = 'input-group';

                    const label = document.createElement('label');
                    label.setAttribute('for', `candidate${i}`);
                    label.textContent = getOrdinalText(i) + '-';

                    const input = document.createElement('input');
                    input.type = 'number';
                    input.id = `candidate${i}`;
                    input.placeholder = 'Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø´Ø­';
                    input.inputMode = 'numeric';
                    input.pattern = '[0-9]*';

                    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ø¨Ù€ iOS
                    if (isIOS) {
                        input.setAttribute('autocomplete', 'off');
                        input.setAttribute('autocorrect', 'off');
                        input.setAttribute('autocapitalize', 'off');
                        input.setAttribute('spellcheck', 'false');
                    }

                    inputGroup.appendChild(label);
                    inputGroup.appendChild(input);
                    votingInputs.appendChild(inputGroup);
                }

                setupInputEventListeners();
                focusFirstInput();

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØªØµÙˆÙŠØª:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù…ÙˆØ°Ø¬');
            }
        }

        function getOrdinalText(number) {
            const ordinals = {
                1: '1', 2: '2', 3: '3', 4: '4', 5: '5',
                6: '6', 7: '7', 8: '8', 9: '9', 10: '10',
                11: '11', 12: '12', 13: '13', 14: '14', 15: '15'
            };
            return ordinals[number] || `Ø§Ù„Ù…Ø±Ø´Ø­ Ø±Ù‚Ù… ${number}`;
        }

        function setupInputEventListeners() {
            try {
                for (let i = 1; i <= candidatesPerVote; i++) {
                    const input = document.getElementById(`candidate${i}`);
                    if (input) {
                        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                        input.removeEventListener('keypress', handleKeyPress);
                        input.removeEventListener('input', handleInput);
                        input.removeEventListener('focus', handleFocus);
                        input.removeEventListener('blur', handleBlur);

                        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                        input.addEventListener('keypress', handleKeyPress.bind(null, i));
                        input.addEventListener('input', handleInput);

                        if (isIOS) {
                            input.addEventListener('focus', handleFocus);
                            input.addEventListener('blur', handleBlur);
                            input.addEventListener('touchstart', handleTouch, { passive: true });
                        }
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«:', error);
            }
        }

        function handleKeyPress(index, e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (index < candidatesPerVote) {
                    const nextInput = document.getElementById(`candidate${index + 1}`);
                    if (nextInput) {
                        nextInput.focus();
                        if (isIOS) {
                            nextInput.click();
                        }
                    }
                } else {
                    recordVote();
                }
            }
        }

        function handleInput(e) {
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù ØºÙŠØ± Ø§Ù„Ø±Ù‚Ù…ÙŠØ©
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        }

        function handleFocus(e) {
            // ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ø´Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ø¹Ù„Ù‰ iOS Ù„ØªØ¬Ù†Ø¨ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚Ù„ Ø¨Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
            setTimeout(() => {
                e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 300);
        }

        function handleBlur(e) {
            // Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„ÙØ¹Ù„ Ø´ÙŠØ¡ Ø®Ø§Øµ Ø¹Ù†Ø¯ ÙÙ‚Ø¯Ø§Ù† Ø§Ù„ØªØ±ÙƒÙŠØ²
        }

        function handleTouch(e) {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³ Ø¹Ù„Ù‰ iOS
            setTimeout(() => {
                e.target.focus();
            }, 10);
        }

        function setupKeyboardListeners() {
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù€ iOS
            document.addEventListener('keydown', (e) => {
                try {
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        recordVote();
                    }
                    else if (e.ctrlKey && e.key === 'z') {
                        e.preventDefault();
                        const undoBtn = document.getElementById('undoBtn');
                        if (undoBtn && !undoBtn.disabled) {
                            undoLastVote();
                        }
                    }
                    else if (e.key === 'Escape') {
                        closeAllModals();
                    }
                } catch (error) {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ø®ØªØµØ§Ø± Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­:', error);
                }
            });

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø®Ø§Øµ Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù„Ù…Ø³
            if (isIOS) {
                document.addEventListener('touchend', (e) => {
                    // Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
                    e.preventDefault();
                }, { passive: false });
            }
        }

        function isValidInteger(value) {
            const trimmedValue = String(value).trim();
            if (trimmedValue === '') return false;

            const num = parseFloat(trimmedValue);
            return !isNaN(num) && Number.isInteger(num) && num > 0;
        }

        function recordVote() {
            try {
                const candidatesPerVote = parseInt(document.getElementById('candidatesPerVote').value);
                const voteNumbers = [];

                // Ø¬Ù…Ø¹ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚
                for (let i = 1; i <= candidatesPerVote; i++) {
                    const input = document.getElementById(`candidate${i}`);
                    if (!input) {
                        showError(`Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ù…Ø±Ø´Ø­ Ø±Ù‚Ù… ${i}`);
                        return;
                    }

                    const inputValue = input.value;

                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
                    if (!isValidInteger(inputValue)) {
                        if (inputValue.trim() === '') {
                            showError(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø´Ø­ Ø±Ù‚Ù… ${i}`);
                        } else {
                            showError(`ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ ÙˆÙ…ÙˆØ¬Ø¨ Ù„Ù„Ù…Ø±Ø´Ø­ Ø±Ù‚Ù… ${i}`);
                        }
                        setTimeout(() => {
                            input.focus();
                            if (isIOS) input.click();
                        }, 100);
                        return;
                    }

                    const value = parseInt(inputValue);

                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
                    if (voteNumbers.includes(value)) {
                        showError(`Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙƒØ±Ø§Ø± Ù†ÙØ³ Ø§Ù„Ù…Ø±Ø´Ø­ (${value}) ÙÙŠ Ø§Ù„ØµÙˆØª Ø§Ù„ÙˆØ§Ø­Ø¯`);
                        setTimeout(() => {
                            input.focus();
                            if (isIOS) input.click();
                        }, 100);
                        return;
                    }

                    voteNumbers.push(value);
                }

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†
                for (let id of voteNumbers) {
                    if (!(id in candidates)) {
                        showError(`Ø§Ù„Ù…Ø±Ø´Ø­ Ø±Ù‚Ù… ${id} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØªÙ‡ Ø£ÙˆÙ„Ø§Ù‹`);
                        for (let i = 1; i <= candidatesPerVote; i++) {
                            const input = document.getElementById(`candidate${i}`);
                            if (input && parseInt(input.value) === id) {
                                setTimeout(() => {
                                    input.focus();
                                    if (isIOS) input.click();
                                }, 100);
                                break;
                            }
                        }
                        return;
                    }
                }

                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£ØµÙˆØ§Øª
                voteNumbers.forEach(num => {
                    candidates[num] = (candidates[num] || 0) + 1;
                });

                validVotes.push([...voteNumbers]);
                voteHistory.push({ type: 'valid', data: [...voteNumbers] });

                // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
                for (let i = 1; i <= candidatesPerVote; i++) {
                    const input = document.getElementById(`candidate${i}`);
                    if (input) input.value = '';
                }

                showSuccess(`ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª ØµØ­ÙŠØ­ Ù„Ù„Ù…Ø±Ø´Ø­ÙŠÙ†: ${voteNumbers.join(', ')}`);
                updateStats();
                updateCandidatesTable();

                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn) undoBtn.disabled = false;

                focusFirstInput();

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª');
            }
        }

        function recordInvalidVote() {
            try {
                invalidVotesCount++;
                voteHistory.push({ type: 'invalid' });
                showSuccess('ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØµÙˆØª Ø¨Ø§Ø·Ù„');
                updateStats();

                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn) undoBtn.disabled = false;

                focusFirstInput();

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø¨Ø§Ø·Ù„:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø¨Ø§Ø·Ù„');
            }
        }

        function undoLastVote() {
            try {
                if (voteHistory.length === 0) return;

                const lastVote = voteHistory.pop();

                if (lastVote.type === 'valid') {
                    lastVote.data.forEach(candidateNum => {
                        if (candidates[candidateNum]) {
                            candidates[candidateNum]--;
                            if (candidates[candidateNum] === 0) {
                                delete candidates[candidateNum];
                            }
                        }
                    });
                    validVotes.pop();
                    showSuccess('ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± ØµÙˆØª ØµØ­ÙŠØ­');
                } else {
                    invalidVotesCount = Math.max(0, invalidVotesCount - 1);
                    showSuccess('ØªÙ… Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± ØµÙˆØª Ø¨Ø§Ø·Ù„');
                }

                const undoBtn = document.getElementById('undoBtn');
                if (undoBtn && voteHistory.length === 0) {
                    undoBtn.disabled = true;
                }

                updateStats();
                updateCandidatesTable();
                focusFirstInput();

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø§Ø¬Ø¹:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ±Ø§Ø¬Ø¹');
            }
        }

        function showAddCandidateModal() {
            const modal = document.getElementById('addCandidateModal');
            if (modal) {
                modal.style.display = 'block';
                const input = document.getElementById('totalCandidatesInput');
                if (input) {
                    setTimeout(() => {
                        input.focus();
                        if (isIOS) input.click();
                    }, 100);
                }
            }
        }

        function addCandidateinput() {
            const totalCandidates = parseInt(document.getElementById('totalCandidatesInput').value);

            if (!totalCandidates || totalCandidates <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†');
                return;
            }

            for (let i = 1; i <= totalCandidates; i++) {
                if (!candidates[i]) {
                    candidates[i] = 0;
                }
            }

            updateStats();
            updateCandidatesTable();
            showSuccess(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${totalCandidates} Ù…Ø±Ø´Ø­`);

        }

        function addCandidates() {
            try {
                const totalCandidatesInput = document.getElementById('totalCandidatesInput');
                if (!totalCandidatesInput) {
                    showError('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
                    return;
                }

                const totalCandidates = parseInt(totalCandidatesInput.value);

                if (!totalCandidates || totalCandidates <= 0) {
                    showError('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù…Ù† Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†');
                    return;
                }

                for (let i = 1; i <= totalCandidates; i++) {
                    if (!candidates[i]) {
                        candidates[i] = 0;
                    }
                }

                closeModal('addCandidateModal');
                updateStats();
                updateCandidatesTable();
                showSuccess(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ${totalCandidates} Ù…Ø±Ø´Ø­`);
                focusFirstInput();

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†');
            }
        }

        function showDeleteCandidateModal() {
            const modal = document.getElementById('deleteCandidateModal');
            if (modal) {
                modal.style.display = 'block';
                const input = document.getElementById('deleteCandidateInput');
                if (input) {
                    setTimeout(() => {
                        input.focus();
                        if (isIOS) input.click();
                    }, 100);
                }
            }
        }

        function deleteCandidate() {
            try {
                const deleteCandidateInput = document.getElementById('deleteCandidateInput');
                if (!deleteCandidateInput) {
                    showError('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„');
                    return;
                }

                const candidateNum = parseInt(deleteCandidateInput.value);

                if (!candidateNum || !candidates[candidateNum]) {
                    showError('Ø§Ù„Ù…Ø±Ø´Ø­ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }

                delete candidates[candidateNum];

                validVotes = validVotes.filter(vote => !vote.includes(candidateNum));
                voteHistory = voteHistory.filter(vote =>
                    vote.type === 'invalid' || !vote.data.includes(candidateNum)
                );

                closeModal('deleteCandidateModal');
                updateStats();
                updateCandidatesTable();
                showSuccess(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø´Ø­ Ø±Ù‚Ù… ${candidateNum}`);
                focusFirstInput();

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø´Ø­:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø±Ø´Ø­');
            }
        }

        function resetAllVotes() {
            try {
                const confirmMessage = 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ';
                if (confirm(confirmMessage)) {
                    candidates = {};
                    validVotes = [];
                    invalidVotesCount = 0;
                    voteHistory = [];

                    const undoBtn = document.getElementById('undoBtn');
                    if (undoBtn) undoBtn.disabled = true;

                    const manualTotalVotesInput = document.getElementById('manualTotalVotesInput');
                    if (manualTotalVotesInput) manualTotalVotesInput.value = '';

                    updateStats();
                    updateCandidatesTable();
                    showSuccess('ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                    focusFirstInput();
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        }

        function updateStats() {
            try {
                const totalCandidatesCount = Object.keys(candidates).length;
                const totalVotesCount = Object.values(candidates).reduce((sum, votes) => sum + votes, 0);
                const totalVoteSetsCount = validVotes.length;
                const castedVotes = totalVoteSetsCount + invalidVotesCount;

                const manualTotalInput = document.getElementById('manualTotalVotesInput');
                const manualTotal = manualTotalInput ? (parseInt(manualTotalInput.value) || 0) : 0;

                const elements = {
                    'totalCandidates': totalCandidatesCount,
                    'totalVotes': manualTotal || totalVotesCount,
                    'totalVoteSets': totalVoteSetsCount,
                    'invalidVotes': invalidVotesCount,
                    'castedVotes': castedVotes
                };

                for (const [id, value] of Object.entries(elements)) {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = value;
                    }
                }

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª:', error);
            }
        }

        function updateCandidatesTable() {
            try {
                const tbody = document.getElementById('candidatesTableBody');
                if (!tbody) {
                    console.error('Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                    return;
                }

                tbody.innerHTML = '';

                const totalVotes = Object.values(candidates).reduce((sum, votes) => sum + votes, 0);
                const sortedCandidates = Object.entries(candidates).sort((a, b) => b[1] - a[1]);

                sortedCandidates.forEach(([candidateNum, votes]) => {
                    const percentage = totalVotes > 0 ? ((votes / totalVotes) * 100).toFixed(2) : 0;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                <td>${candidateNum}</td>
                <td>${votes}</td>
                <td>${percentage}%</td>
            `;
                    tbody.appendChild(row);
                });

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†:', error);
            }
        }

        function showError(message) {
            try {
                const errorAlert = document.getElementById('errorAlert');
                if (errorAlert) {
                    errorAlert.textContent = message;
                    errorAlert.style.display = 'block';
                    setTimeout(() => {
                        errorAlert.style.display = 'none';
                    }, 5000);
                } else {
                    alert('Ø®Ø·Ø£: ' + message);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£:', error);
                alert('Ø®Ø·Ø£: ' + message);
            }
        }

        function showSuccess(message) {
            try {
                const successAlert = document.getElementById('successAlert');
                if (successAlert) {
                    successAlert.textContent = message;
                    successAlert.style.display = 'block';
                    setTimeout(() => {
                        successAlert.style.display = 'none';
                    }, 3000);
                } else {
                    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø³ÙŠØ· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø¹Ù†ØµØ± Ù…ØªØ§Ø­Ø§Ù‹
                    console.log('Ù†Ø¬Ø­: ' + message);
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­:', error);
            }
        }

        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
                focusFirstInput();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©:', error);
            }
        }

        function closeAllModals() {
            try {
                const modals = document.querySelectorAll('.modal');
                modals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
                focusFirstInput();
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©:', error);
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        window.onclick = function (event) {
            try {
                const modals = document.getElementsByClassName('modal');
                for (let modal of modals) {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                        focusFirstInput();
                    }
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ù†Ù‚Ø±:', error);
            }
        }

        function setupSaveLoadButtons() {
            try {
                const saveDataBtn = document.getElementById('saveDataBtn');
                const loadDataBtn = document.getElementById('loadDataBtn');

                if (saveDataBtn) {
                    saveDataBtn.addEventListener("click", saveData);
                }

                if (loadDataBtn) {
                    loadDataBtn.addEventListener("click", loadData);
                }

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­ÙØ¸ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©:', error);
            }
        }

        function saveData() {
            if (isProcessing) return;
            isProcessing = true;

            try {
                const dataToSave = {
                    candidates: candidates,
                    validVotes: validVotes,
                    invalidVotesCount: invalidVotesCount,
                    voteHistory: voteHistory,
                    candidatesPerVote: candidatesPerVote,
                    timestamp: new Date().toISOString()
                };

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… localStorage
                if (typeof (Storage) !== "undefined") {
                    localStorage.setItem("voteCounterData", JSON.stringify(dataToSave));
                    showSuccess("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
                } else {
                    showError("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                }

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message);
            }

            isProcessing = false;
        }

        function loadData() {
            if (isProcessing) return;
            isProcessing = true;

            try {
                if (typeof (Storage) === "undefined") {
                    showError("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                    isProcessing = false;
                    return;
                }

                const data = localStorage.getItem("voteCounterData");
                if (data) {
                    const parsed = JSON.parse(data);
                    candidates = parsed.candidates || {};
                    validVotes = parsed.validVotes || [];
                    invalidVotesCount = parsed.invalidVotesCount || 0;
                    voteHistory = parsed.voteHistory || [];
                    candidatesPerVote = parsed.candidatesPerVote || 1;

                    // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ù„ÙƒÙ„ ØµÙˆØª
                    const candidatesPerVoteElement = document.getElementById('candidatesPerVote');
                    if (candidatesPerVoteElement) {
                        candidatesPerVoteElement.value = candidatesPerVote;
                    }

                    updateVotingForm();
                    updateStats();
                    updateCandidatesTable();

                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„ØªØ±Ø§Ø¬Ø¹
                    const undoBtn = document.getElementById('undoBtn');
                    if (undoBtn) {
                        undoBtn.disabled = voteHistory.length === 0;
                    }

                    // Ø¹Ø±Ø¶ ÙˆÙ‚Øª Ø¢Ø®Ø± Ø­ÙØ¸
                    if (parsed.timestamp) {
                        const saveDate = new Date(parsed.timestamp);
                        const formattedDate = saveDate.toLocaleString('ar-EG');
                        showSuccess(`ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­\nØ¢Ø®Ø± Ø­ÙØ¸: ${formattedDate}`);
                    } else {
                        showSuccess("ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
                    }
                } else {
                    showError("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©");
                }

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showError("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + error.message);
            }

            isProcessing = false;
        }

        function setupAutoSave() {
            try {
                setInterval(() => {
                    const totalVotesCount = Object.values(candidates).reduce((sum, votes) => sum + votes, 0);
                    if (!isProcessing && totalVotesCount > 0 && typeof (Storage) !== "undefined") {
                        try {
                            const dataToSave = {
                                candidates: candidates,
                                validVotes: validVotes,
                                invalidVotesCount: invalidVotesCount,
                                voteHistory: voteHistory,
                                candidatesPerVote: candidatesPerVote,
                                timestamp: new Date().toISOString()
                            };
                            localStorage.setItem("voteCounterData_auto", JSON.stringify(dataToSave));
                            console.log("ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: " + new Date().toLocaleTimeString());
                        } catch (error) {
                            console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: ", error);
                        }
                    }
                }, 30000); // Ø­ÙØ¸ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:', error);
            }
        }

        function loadDataOnStartup() {
            try {
                if (typeof (Storage) === "undefined") {
                    console.log("Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… localStorage");
                    return;
                }

                const data = localStorage.getItem("voteCounterData");
                if (data) {
                    const parsed = JSON.parse(data);
                    candidates = parsed.candidates || {};
                    validVotes = parsed.validVotes || [];
                    invalidVotesCount = parsed.invalidVotesCount || 0;
                    voteHistory = parsed.voteHistory || [];
                    candidatesPerVote = parsed.candidatesPerVote || 1;

                    // ØªØ­Ø¯ÙŠØ« Ù‚ÙŠÙ…Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ù„ÙƒÙ„ ØµÙˆØª
                    const candidatesPerVoteElement = document.getElementById('candidatesPerVote');
                    if (candidatesPerVoteElement) {
                        candidatesPerVoteElement.value = candidatesPerVote;
                    }

                    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„ØªØ±Ø§Ø¬Ø¹
                    const undoBtn = document.getElementById('undoBtn');
                    if (undoBtn) {
                        undoBtn.disabled = voteHistory.length === 0;
                    }

                    console.log("ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù†Ø¬Ø§Ø­");
                }

            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ", error);
            }
        }

        // Ù…Ù†Ø¹ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø®Ø·Ø£
        window.addEventListener('beforeunload', function (e) {
            try {
                const totalVotesCount = Object.values(candidates).reduce((sum, votes) => sum + votes, 0);
                if (totalVotesCount > 0 && !isProcessing) {
                    const message = 'Ù„Ø¯ÙŠÙƒ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø­ÙÙˆØ¸Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©ØŸ';
                    e.preventDefault();
                    e.returnValue = message;
                    return message;
                }
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬ beforeunload:', error);
            }
        });

        // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø®Ø§ØµØ© Ø¨Ù€ iOS Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙˆØ§Ù„ØªØ±ÙƒÙŠØ²
        if (isIOS) {
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¸Ù‡ÙˆØ±/Ø§Ø®ØªÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­
            window.addEventListener('resize', function () {
                setTimeout(() => {
                    const activeElement = document.activeElement;
                    if (activeElement && activeElement.tagName === 'INPUT') {
                        activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 300);
            });

            // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù†Ø¯ Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.addEventListener('focusin', function (e) {
                if (e.target.tagName === 'INPUT') {
                    setTimeout(() => {
                        e.target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            });

            // Ø¥Ø¶Ø§ÙØ© Ø¯Ø¹Ù… Ø£ÙØ¶Ù„ Ù„Ù„Ù…Ø³
            document.addEventListener('touchend', function (e) {
                // Ù…Ù†Ø¹ Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø²Ø¯ÙˆØ¬
                let lastTouchEnd = 0;
                const now = (new Date()).getTime();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        function validateData() {
            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                const requiredElements = [
                    'candidatesPerVote',
                    'votingInputs',
                    'votingSectionTitle',
                    'candidatesTableBody'
                ];

                for (const elementId of requiredElements) {
                    if (!document.getElementById(elementId)) {
                        console.warn(`Ø§Ù„Ø¹Ù†ØµØ± ${elementId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„ØµÙØ­Ø©`);
                        return false;
                    }
                }

                return true;
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                return false;
            }
        }

        // Ø¯Ø§Ù„Ø© Ù„Ù„ØªÙ†Ø¸ÙŠÙ Ø¹Ù†Ø¯ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        function cleanup() {
            try {
                // Ø¥Ø²Ø§Ù„Ø© Ø¬Ù…ÙŠØ¹ Ù…Ø³ØªÙ…Ø¹Ø§Øª Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
                const inputs = document.querySelectorAll('input[type="number"]');
                inputs.forEach(input => {
                    input.removeEventListener('keypress', handleKeyPress);
                    input.removeEventListener('input', handleInput);
                    input.removeEventListener('focus', handleFocus);
                    input.removeEventListener('blur', handleBlur);
                    input.removeEventListener('touchstart', handleTouch);
                });

                console.log('ØªÙ… ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', error);
            }
        }

        // Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù…Ø©
        window.addEventListener('error', function (e) {
            console.error('Ø®Ø·Ø£ Ø¹Ø§Ù… ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', e.error);
            showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
        });

        // Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙÙŠ Ø§Ù„Ù€ Promise
        window.addEventListener('unhandledrejection', function (e) {
            console.error('Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø§Ù„Ø¬ ÙÙŠ Promise:', e.reason);
            showError('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        });

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ (Ù„Ù„ØªØ´Ø®ÙŠØµ)
        function logBrowserInfo() {
            console.log('Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØµÙØ­:', {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                isIOS: isIOS,
                localStorage: typeof (Storage) !== "undefined",
                touchSupport: 'ontouchstart' in window
            });
        }

        // ØªØ´ØºÙŠÙ„ ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ØªØµÙØ­ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.addEventListener('DOMContentLoaded', function () {
            logBrowserInfo();
        });

        // Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„

        // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø§Ù„Ù…Ø·Ø§Ø·ÙŠ Ø¹Ù„Ù‰ iOS
        document.addEventListener('touchmove', function (e) {
            if (isIOS) {
                const target = e.target;
                const isScrollable = target.scrollHeight > target.clientHeight;

                if (!isScrollable) {
                    e.preventDefault();
                }
            }
        }, { passive: false });

        // ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø¹Ø¨Ø± ØªÙ‚Ù„ÙŠÙ„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±Ø³Ù…
        function throttle(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ØªØ·Ø¨ÙŠÙ‚ throttling Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        const throttledUpdateStats = throttle(updateStats, 100);
        const throttledUpdateCandidatesTable = throttle(updateCandidatesTable, 100);

        // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Ø¯Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ø³Ù†Ø© ÙÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        function recordVoteOptimized() {
            // Ù†ÙØ³ ÙƒÙˆØ¯ recordVote Ù„ÙƒÙ† Ù…Ø¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ù…Ø­Ø³Ù†Ø©
            recordVote();
            throttledUpdateStats();
            throttledUpdateCandidatesTable();
        }

        // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = {
                recordVote,
                recordInvalidVote,
                undoLastVote,
                addCandidates,
                deleteCandidate,
                resetAllVotes,
                saveData,
                loadData,
                updateVotingForm,
                showAddCandidateModal,
                showDeleteCandidateModal,
                closeModal
            };
        }

        // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        console.log('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø¹Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª Ø¨Ù†Ø¬Ø§Ø­ - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ iOS');
        async function exportToPDF(event) {
            if (event) event.preventDefault();

            const exportBtn = document.getElementById('exportPdfBtn');
            const originalText = exportBtn.innerHTML;

            // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± ÙˆØ¹Ø±Ø¶ Ù…Ø¤Ø´Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„
            exportBtn.disabled = true;
            exportBtn.innerHTML = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ¯ÙŠØ±...';
            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });

                // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const totalCandidates = document.getElementById('totalCandidates').textContent;
                const totalVotes = document.getElementById('totalVotes').textContent;
                const totalVoteSets = document.getElementById('totalVoteSets').textContent;
                const invalidVotes = document.getElementById('invalidVotes').textContent;
                const manualTotal = document.getElementById('manualTotalVotesInput').value || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                const tableBody = document.getElementById('candidatesTableBody');

                const reportDate = new Date().toLocaleDateString('ar-EG', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let candidatesData = [];
                if (tableBody && tableBody.children.length > 0) {
                    candidatesData = Array.from(tableBody.children).map(row => ({
                        number: row.children[0].textContent,
                        votes: row.children[1].textContent,
                        percentage: row.children[2].textContent
                    }));
                }

                const candidatePages = [];
                let currentIndex = 0;

                if (candidatesData.length > 0) {
                    const firstPageCount = Math.min(7, candidatesData.length);
                    candidatePages.push(candidatesData.slice(0, firstPageCount));
                    currentIndex = firstPageCount;
                }

                while (currentIndex < candidatesData.length) {
                    const nextPageCount = Math.min(14, candidatesData.length - currentIndex);
                    candidatePages.push(candidatesData.slice(currentIndex, currentIndex + nextPageCount));
                    currentIndex += nextPageCount;
                }

                let pageHtml = createFirstPageHTML(reportDate, totalCandidates, totalVotes, totalVoteSets, invalidVotes, candidatePages[0] || [], 1);
                await addPageToPDF(pdf, pageHtml, true);

                let serialStart = candidatePages[0] ? candidatePages[0].length + 1 : 1;
                for (let i = 1; i < candidatePages.length; i++) {
                    pdf.addPage();
                    pageHtml = createCandidatesPageHTML(candidatePages[i], i + 1, candidatePages.length, serialStart);
                    await addPageToPDF(pdf, pageHtml, false);
                    serialStart += candidatePages[i].length;
                }

                if (candidatePages.length > 0) {
                    pdf.addPage();
                    pageHtml = createFinalPageHTML(reportDate);
                    await addPageToPDF(pdf, pageHtml, false);
                }

                const fileName = `ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ù†ØªØ§Ø¦Ø¬_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(fileName);

                showAlert('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!', 'success');

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± PDF:', error);
                showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ±', 'error');
            } finally {
                exportBtn.disabled = false;
                exportBtn.innerHTML = originalText;
            }
        }
        document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);

        async function addPageToPDF(pdf, htmlContent, isFirstPage) {
            const container = document.createElement('div');
            container.style.cssText = `
                position: absolute;
                left: -9999px;
                top: 0;
                width: 794px;
                background: white;
                padding: 40px;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                direction: rtl;
                color: #333;
                line-height: 1.6;
            `;

            container.innerHTML = htmlContent;
            document.body.appendChild(container);

            const canvas = await html2canvas(container, {
                scale: 2,
                useCORS: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                scrollX: 0,
                scrollY: 0
            });

            document.body.removeChild(container);

            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 210;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        }

        function createFirstPageHTML(reportDate, totalCandidates, totalVotes, totalVoteSets, invalidVotes, firstPageCandidates, serialStart = 1) {
            let candidatesTableHTML = '';

            if (firstPageCandidates.length > 0) {
                candidatesTableHTML = `
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <thead>
                            <tr style="background: linear-gradient(45deg, #667eea, #764ba2); color: white;">
                                <th style="padding: 15px; border: 1px solid #ddd; text-align: center; width: 80px;">Ù…</th>
                                <th style="padding: 15px; border: 1px solid #ddd; text-align: center;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø´Ø­</th>
                                <th style="padding: 15px; border: 1px solid #ddd; text-align: center;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª</th>
                                <th style="padding: 15px; border: 1px solid #ddd; text-align: center;">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                firstPageCandidates.forEach((candidate, index) => {
                    const bgColor = index % 2 === 0 ? '#f8f9ff' : 'white';
                    candidatesTableHTML += `
                        <tr style="background: ${bgColor};">
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #667eea;">${serialStart + index}</td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${candidate.number}</td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${candidate.votes}</td>
                            <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${candidate.percentage}</td>
                        </tr>
                    `;
                });

                candidatesTableHTML += '</tbody></table>';
            } else {
                candidatesTableHTML = '<p style="color: #666; text-align: center; margin: 20px 0;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
            }

            return `
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 30px; text-align: center; border-radius: 10px; margin-bottom: 30px;">
                    <h1 style="margin: 0; font-size: 28px;">ØªÙ‚Ø±ÙŠØ± Ù†ØªØ§Ø¦Ø¬ ÙØ±Ø² Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠØ©</h1>
                </div>

                <div style="margin-bottom: 30px;">
                    <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px;">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ±</h2>
                    <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±:</strong> ${reportDate}</p>
                    <p><strong>Ø§Ù„Ù†Ø¸Ø§Ù…:</strong> Ù†Ø¸Ø§Ù… ÙØ±Ø² Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠØ©</p>
                </div>

                <div style="margin-bottom: 30px;">
                    <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px;">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0;">
                        <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-right: 4px solid #667eea;">
                            <strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†:</strong> ${totalCandidates}
                        </div>
                        <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-right: 4px solid #667eea;">
                            <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆØ§Øª:</strong> ${totalVotes}
                        </div>
                        <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-right: 4px solid #667eea;">
                            <strong>Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©:</strong> ${totalVoteSets}
                        </div>
                        <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-right: 4px solid #667eea;">
                            <strong>Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø¨Ø§Ø·Ù„Ø©:</strong> ${invalidVotes}
                        </div>
                        <div style="background: #f8f9ff; padding: 15px; border-radius: 8px; border-right: 4px solid #667eea; margin-top: 15px;">
                            <strong>Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ù…ÙØ¯Ù„Ù‰ Ø¨Ù‡Ø§:</strong> ${parseInt(totalVoteSets) + parseInt(invalidVotes)}
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ†</h2>
                    ${candidatesTableHTML}
                </div>
            `;
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ ØµÙØ­Ø§Øª Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
        function createCandidatesPageHTML(candidates, pageNumber, totalPages, serialStart) {
            let candidatesTableHTML = `
                <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                    <thead>
                        <tr style="background: linear-gradient(45deg, #667eea, #764ba2); color: white;">
                            <th style="padding: 15px; border: 1px solid #ddd; text-align: center; width: 80px;">Ù…</th>
                            <th style="padding: 15px; border: 1px solid #ddd; text-align: center;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø´Ø­</th>
                            <th style="padding: 15px; border: 1px solid #ddd; text-align: center;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ØµÙˆØ§Øª</th>
                            <th style="padding: 15px; border: 1px solid #ddd; text-align: center;">Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            candidates.forEach((candidate, index) => {
                const bgColor = index % 2 === 0 ? '#f8f9ff' : 'white';
                candidatesTableHTML += `
                    <tr style="background: ${bgColor};">
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center; font-weight: bold; color: #667eea;">${serialStart + index}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${candidate.number}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${candidate.votes}</td>
                        <td style="padding: 12px; border: 1px solid #ddd; text-align: center;">${candidate.percentage}</td>
                    </tr>
                `;
            });

            candidatesTableHTML += '</tbody></table>';

            return `
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 30px;">
                    <h1 style="margin: 0; font-size: 24px;">ØªÙƒÙ…Ù„Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† - ØµÙØ­Ø© ${pageNumber}</h1>
                </div>

                <div style="margin-bottom: 30px;">
                    <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px;">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø±Ø´Ø­ÙŠÙ† (ØªÙƒÙ…Ù„Ø©)</h2>
                    ${candidatesTableHTML}
                </div>

                <div style="text-align: center; color: #666; border-top: 1px solid #ddd; padding-top: 20px; margin-top: 40px;">
                    <p>ØµÙØ­Ø© ${pageNumber} Ù…Ù† ${totalPages}</p>
                </div>
            `;
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        function createFinalPageHTML(reportDate) {
            return `
                <div style="background: linear-gradient(45deg, #667eea, #764ba2); color: white; padding: 20px; text-align: center; border-radius: 10px; margin-bottom: 30px;">
                    <h1 style="margin: 0; font-size: 24px;">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª</h1>
                </div>

                <div style="margin-bottom: 30px;">
                    <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h2>
                    <ul style="color: #666; padding-right: 20px;">
                        <li>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¢Ù„ÙŠØ§Ù‹ Ù…Ù† Ù†Ø¸Ø§Ù… ÙØ±Ø² Ø§Ù„Ø£ØµÙˆØ§Øª Ø§Ù„Ø§Ù†ØªØ®Ø§Ø¨ÙŠØ©</li>
                        <li>ÙŠÙØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡Ø§ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„ÙŠÙ‡Ø§</li>
                    </ul>
                </div>

                <div style="margin-bottom: 50px;">
                    <h2 style="color: #667eea; border-bottom: 3px solid #667eea; padding-bottom: 10px;">Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-top: 40px;">
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; width: 200px; margin: 40px auto 10px;"></div>
                            <p><strong>Ø±Ø¦ÙŠØ³ Ø§Ù„Ù„Ø¬Ù†Ø©</strong></p>
                        </div>
                        <div style="text-align: center;">
                            <div style="border-bottom: 2px solid #333; width: 200px; margin: 40px auto 10px;"></div>
                            <p><strong>Ø£Ù…ÙŠÙ† Ø§Ù„Ù„Ø¬Ù†Ø©</strong></p>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; color: #666; border-top: 1px solid #ddd; padding-top: 20px; margin-top: 40px;">
                    <p>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ ${reportDate}</p>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <p style="font-size: 1.1rem; color: #444;">
                        Ø¥Ù‡Ø¯Ø§Ø¡ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± <strong>Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ù…Ø±Ø§ÙˆÙŠ</strong> Ù„Ù„Ø³Ø§Ø¯Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
                    </p>
                </div>
            `;
        }
    </script>
</body>

</html>
